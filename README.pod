=head1 NAME

Teng::Row::Declare::Relationship - DSL for declaring relationships

=head1 SYNOPSIS

  package MyModel::Row::User;
  use parent 'Teng::Row';
  use Teng::Row::Declare::Relationship;
  BEGIN {
      has_many bookmark => { alias => 'bookmarks' };
  }
  1;

in your script.

  my $user = $teng->single('user', { id => 1 });
  my $bookmarks = $user->bookmarks;
  # => SELECT "id", "user_id", "url" FROM "bookmark" WHERE ("user_id" = '1')

=head1 DESCRIPTION

Teng::Row::Declare::Relationship is set of macro-like class methods for declaring method to set up a simple relationships.

=head1 METHODS

=head2 C<has_one>

Specifies a one-to-one relationship with another table.

  has_one 'section';

=head2 C<has_many>

Specifies a one-to-many relationship with another table.

  has_many 'bookmark' => { alias => 'bookmarks' };

=head2 C<belongs_to>

Specifies a one-to-one relationship with another table.

  belongs_to 'user';

=head1 OPTIONS

  has_many bookmark => { primary_key => 'name', foreign_key => 'person_name', alias => 'fetch_bookmarks' }

=head2 C<alias>

set alias.

=head2 C<primary_key>

set primary key used for the relationship. By default this is 'id'.

=head2 C<foreign_key>

set foreign key used for the relationship.

=over 4

=item has_*

By default this is guessed to be the name of this table in lower-case and  "_id" suffixed.

=item belongs_to

By default this is guessed to be the name of the relationship with an "_id" suffix.

=back

=head2 C<conditions>

set the conditions that the relationship objects must meet in order to be included.

  has_many post => { alias => 'posts', conditions => { published => 1 } };

  my $published_posts = $blog->posts;
  # => SELECT "id", "user_id", "title", "published" FROM "post" WHERE ("user_id" = ?) AND ("published" = '1')

see L<Teng search/single methods|https://metacpan.org/module/Teng#METHODS>.

=head2 C<attributes>

set attributes for search.

  has_many bookmark => { alias => 'bookmarks', attributes => { order_by => 'url DESC' } };

  my $sorted_bookmarks = $user->bookmarks;
  # => SELECT "id", "user_id", "url" FROM "bookmark" WHERE ("user_id" = ?) ORDER BY url DESC

see L<Teng search method|https://metacpan.org/module/Teng#METHODS>.

=head1 EXAMPLES

=head2 caching

  package MyModel;
  use parent 'Teng::Row';
  use Teng::Row::Declare::Relationship;
  $Teng::Row::Declare::Relationship::FETCH = sub {
      my $self = shift;
      my ( $name, $conds, $attrs, $has_one, $alias, @args ) = @_;
      my $key = "__cached_$alias";
      $self->{$key} = undef if ( @args && $args[0] ); # refetch
      $self->{$key} ||= ($has_one)
          ? $self->handle->single( $name => $conds, $attrs )
          : [ $self->handle->search( $name => $conds, $attrs )->all ];
  };
  1;

=head1 AUTHOR

hayajo E<lt>hayajo@cpan.orgE<gt>

=head1 SEE ALSO

L<Teng>, L<DBIx::Skinny>, L<http://perl-users.jp/articles/advent-calendar/2009/dbix-skinny/21.html>

=head1 LICENSE

This library is free software; you can redistribute it and/or modify
it under the same terms as Perl itself.


=cut

